<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EOPStop</title>
    <style>
        /* Theme Variables */
        :root {
            --bg-main: #000000;
            --text-primary: #eeeeee;
            --osd-bg: rgba(0, 0, 0, 0.75);
            --timeline-bg: rgba(255, 255, 255, 0.1);
            --timeline-fill: #ffffff;
            --font-stack: sans-serif;
            --icon-size: 28px; 
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; user-select: none; }
        
        body {
            font-family: var(--font-stack);
            background-color: var(--bg-main);
            color: var(--text-primary);
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
        }

        /* Utils */
        .hidden { display: none !important; }
        .font-mono { font-family: monospace; }
        
        svg { width: var(--icon-size); height: var(--icon-size); fill: currentColor; }
        
        .btn-icon {
            background: transparent;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            padding: 0 12px;
            height: 100%; 
            display: flex; align-items: center; justify-content: center;
            opacity: 0.9;
            transition: background 0.1s;
        }
        .btn-icon:hover { opacity: 1; color: #fff; background: rgba(255,255,255,0.1); }
        .btn-icon:active { transform: translateY(1px); }

        /* Layout */
        #app-container {
            display: flex;
            width: 100%;
            height: 100%;
        }

        #main-area {
            flex: 1;
            position: relative;
            background: #000;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Video Area */
        #video-container {
            flex: 1;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
        }

        video {
            width: 100%;
            height: 100%;
            max-height: 100vh;
            object-fit: contain;
        }

        /* Title Overlay */
        #title-overlay {
            position: absolute;
            top: 0; left: 0; right: 0;
            padding: 10px 15px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            pointer-events: none;
            font-size: 16px;
            font-weight: bold;
            text-shadow: 1px 1px 2px black;
            opacity: 0;
            z-index: 18;
            display: flex; justify-content: space-between;
        }
        #main-area:hover #title-overlay { opacity: 1; }

        .file-controls {
            pointer-events: auto;
            display: flex; gap: 15px;
            font-size: 13px;
            font-weight: normal;
            opacity: 0.8;
        }
        .file-controls span:hover { text-decoration: underline; cursor: pointer; color: white; opacity: 1; }

        /* Controls  */
        #ui-trigger-zone {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            height: 80px; 
            z-index: 19;
        }

        #controls-bar {
            position: absolute;
            bottom: 0; left: 0; right: 0; 
            background: var(--osd-bg);
            height: 30px; 
            display: flex;
            align-items: center;
            padding: 0;
            opacity: 0;
            z-index: 20;
            pointer-events: none;
            border-radius: 0; 
            box-shadow: none;
        }

        #ui-trigger-zone:hover ~ #controls-bar,
        #controls-bar:hover,
        #main-area.paused #controls-bar {
            opacity: 1;
            pointer-events: auto;
        }

        /* Timeline */
        .timeline-container {
            flex: 1;
            height: 100%; 
            display: flex;
            align-items: center;
            cursor: pointer;
            position: relative;
            margin: 0; 
        }
        
        .timeline-track {
            width: 100%;
            height: 100%; /* HUGE chunky bar fills container */
            background: var(--timeline-bg);
            position: relative;
            border-radius: 0;
        }

        .timeline-fill {
            height: 100%;
            background: var(--timeline-fill);
            width: 0%;
            position: relative;
            border-radius: 0;
        }
        
        /* Time Text */
        .time-block {
            font-family: monospace;
            font-size: 15px;
            font-weight: bold;
            color: #ddd;
            white-space: nowrap;
            min-width: 90px;
            text-align: center;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 5px;
        }

        /* Offset Controls */
        .offset-controls {
            display: flex;
            align-items: center;
            height: 100%;
            border-left: 1px solid rgba(255,255,255,0.1);
            border-right: 1px solid rgba(255,255,255,0.1);
        }
        
        .offset-btn { 
            background: transparent; 
            border: none;
            color: #ccc; 
            width: 40px; height: 100%; 
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 18px; font-weight: bold;
            transition: background 0.1s;
        }
        .offset-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        
        #offset-disp {
            padding: 0 10px;
            font-size: 14px;
            min-width: 60px;
            text-align: center;
            font-weight: bold;
        }

        /* Subtitles */
        #sub-layer {
            position: absolute;
            bottom: 60px; /* Sits just above the flush bar */
            left: 0; right: 0;
            text-align: center;
            padding: 0 40px;
            z-index: 25; 
            pointer-events: none;
        }

        #sub-text {
            display: inline-block;
            color: #ffffff; 
            font-size: 38px;
            font-weight: 600;
            font-family: sans-serif;
            text-shadow: 
                -2px -2px 0 #000, 2px -2px 0 #000,
                -2px 2px 0 #000, 2px 2px 0 #000,
                0 2px 5px rgba(0,0,0,1);
            pointer-events: auto;
            user-select: text;
            cursor: text;
        }

        /* Sidebar */
        #sidebar {
            width: 320px;
            background: #111;
            border-left: 1px solid #222;
            display: flex;
            flex-direction: column;
            transition: margin-right 0.2s ease;
            flex-shrink: 0; 
        }
        #sidebar.collapsed { display: none; }

        .sidebar-header {
            padding: 15px 16px;
            background: #151515;
            border-bottom: 1px solid #222;
            color: #ddd;
            font-size: 12px;
            font-weight: bold;
            display: flex; justify-content: space-between;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        #sub-list { flex: 1; overflow-y: auto; }
        #sub-list::-webkit-scrollbar { width: 8px; }
        #sub-list::-webkit-scrollbar-track { background: #111; }
        #sub-list::-webkit-scrollbar-thumb { background: #444; }

        .sub-item {
            padding: 10px 12px 10px 16px;
            color: #888;
            font-size: 13px;
            line-height: 1.4;
            border-bottom: 1px solid #1a1a1a;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        .sub-item:hover { background: #222; color: #eee; }
        .sub-item.active { background: #333; color: white; font-weight: bold; border-left: 3px solid #fff; }
        
        .sub-content { flex: 1; cursor: pointer; }
        .sub-meta { color: #555; font-size: 11px; margin-bottom: 4px; font-family: monospace; }
        
        .sync-btn {
            opacity: 0;
            color: #ff5555;
            background: transparent;
            border: 1px solid #444;
            padding: 4px 6px;
            margin-left: 10px;
            cursor: pointer;
        }
        .sub-item:hover .sync-btn { opacity: 0.5; }
        .sync-btn:hover { opacity: 1 !important; background: #222; border-color: #ff5555; }

        /* Drag Drop */
        #drag-overlay {
            position: absolute; inset: 0;
            background: rgba(0,0,0,0.85);
            display: flex; align-items: center; justify-content: center;
            z-index: 100; color: white; font-size: 2rem;
            border: 6px dashed #444;
            margin: 20px;
        }
        
    </style>
</head>
<body>

    <input type="file" id="video-input" accept="video/*, .mkv, .webm, .mp4" class="hidden">
    <input type="file" id="sub-input" accept=".srt, .vtt, .ass, .ssa" class="hidden">

    <div id="drag-overlay" class="hidden">DROP FILES</div>

    <div id="app-container">
        
        <div id="main-area" class="paused">
            
            <div id="title-overlay">
                <span id="video-title">No Video Loaded</span>
                <div class="file-controls">
                    <span onclick="document.getElementById('video-input').click()">Open Video</span>
                    <span onclick="document.getElementById('sub-input').click()">Open Subs</span>
                    <span id="sidebar-toggle">Sidebar</span>
                </div>
            </div>

            <div id="video-container">
                <video id="main-video" class="hidden" playsinline></video>
                <div id="sub-layer" class="hidden">
                    <span id="sub-text"></span>
                </div>
            </div>

            <div id="ui-trigger-zone"></div>

            <div id="controls-bar">
                <!-- Play -->
                <button class="btn-icon" id="play-btn">
                    <svg viewBox="0 0 24 24" id="icon-play"><path d="M8 5v14l11-7z"/></svg>
                    <svg viewBox="0 0 24 24" id="icon-pause" class="hidden"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                </button>

                <!-- Total/Current Time -->
                <div class="time-block" id="time-left">00:00:00</div>

                <!-- Timeline -->
                <div class="timeline-container" id="progress-bar">
                    <div class="timeline-track">
                        <div class="timeline-fill" id="progress-fill"></div>
                    </div>
                </div>

                <!-- Time Remaining -->
                <div class="time-block" id="time-right">-00:00:00</div>

                <!-- Delay Controls -->
                <div class="offset-controls">
                    <button class="offset-btn" onclick="adjustOffset(-50)">-</button>
                    <span class="font-mono" id="offset-disp">0ms</span>
                    <button class="offset-btn" onclick="adjustOffset(50)">+</button>
                </div>

                <!-- Volume -->
                <button class="btn-icon" id="mute-btn">
                    <svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
                </button>

                <!-- Fullscreen -->
                <button class="btn-icon" id="fullscreen-btn">
                    <svg viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>
                </button>
            </div>
        </div>

        <div id="sidebar">
            <div class="sidebar-header">
                <span>Subtitles</span>
                <span id="sub-count">0</span>
            </div>
            <div id="sub-list">
                <div style="padding:20px; text-align:center; color:#444; font-size:12px;">No subtitles</div>
            </div>
        </div>
    </div>

    <script>
        // State
        const state = {
            videoUrl: null,
            subs: [],
            offset: 0,
            currentSubIndex: -1,
            sidebarOpen: true,
            isFullscreen: false
        };

        // Elements
        const els = {
            container: document.getElementById('main-area'),
            video: document.getElementById('main-video'),
            title: document.getElementById('video-title'),
            subLayer: document.getElementById('sub-layer'),
            subText: document.getElementById('sub-text'),
            sidebar: document.getElementById('sidebar'),
            subList: document.getElementById('sub-list'),
            progressFill: document.getElementById('progress-fill'),
            timeLeft: document.getElementById('time-left'),
            timeRight: document.getElementById('time-right'),
            offsetDisp: document.getElementById('offset-disp')
        };

        // Helpers
        const formatTime = (s) => {
            if (!Number.isFinite(s)) return "00:00:00";
            const h = Math.floor(s / 3600);
            const m = Math.floor((s % 3600) / 60);
            const sec = Math.floor(s % 60);
            return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
        };

        const msToTimeStr = (ms) => {
            const date = new Date(ms);
            return date.toISOString().substr(11, 8) + '.' + Math.floor(ms%1000).toString().padStart(3,'0');
        };

        const parseSRT = (text) => {
            const subs = [];
            const blocks = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n').split('\n\n');
            blocks.forEach(block => {
                const lines = block.trim().split('\n');
                if (lines.length >= 2) {
                    const timeLine = lines.find(l => l.includes('-->'));
                    if (timeLine) {
                        const [startStr, endStr] = timeLine.split('-->');
                        const parse = (t) => {
                            const [main, ms] = t.trim().split(/[,.]/);
                            const [h, m, s] = main.split(':').map(Number);
                            return (h*3600000) + (m*60000) + (s*1000) + (parseInt(ms)||0);
                        };
                        subs.push({
                            start: parse(startStr),
                            end: parse(endStr),
                            text: lines.slice(lines.indexOf(timeLine)+1).join('<br>').replace(/<[^>]*>/g, '')
                        });
                    }
                }
            });
            return subs;
        };

        // Core
        const loadVideo = (file) => {
            els.video.classList.remove('hidden');
            if (state.videoUrl) URL.revokeObjectURL(state.videoUrl);
            state.videoUrl = URL.createObjectURL(file);
            els.video.src = state.videoUrl;
            els.title.innerText = file.name;
            els.video.currentTime = 0;
            updatePlayState(false);
            
            if (window.innerWidth < 1000) {
                state.sidebarOpen = false;
                els.sidebar.classList.add('collapsed');
            }
        };

        const loadSubs = (file) => {
            const r = new FileReader();
            r.onload = e => {
                state.subs = parseSRT(e.target.result);
                state.currentSubIndex = -1;
                renderSidebar();
            };
            r.readAsText(file);
        };

        const updatePlayState = (playing) => {
            if (playing) {
                els.video.play();
                els.container.classList.remove('paused');
                document.getElementById('icon-play').classList.add('hidden');
                document.getElementById('icon-pause').classList.remove('hidden');
            } else {
                els.video.pause();
                els.container.classList.add('paused');
                els.container.classList.remove('playing');
                document.getElementById('icon-play').classList.remove('hidden');
                document.getElementById('icon-pause').classList.add('hidden');
            }
        };

        const updateSubtitles = (currentTimeMs) => {
            const t = currentTimeMs;
            const cur = state.subs[state.currentSubIndex];
            if (cur && t >= (cur.start + state.offset) && t <= (cur.end + state.offset)) return;

            const idx = state.subs.findIndex(s => t >= (s.start + state.offset) && t <= (s.end + state.offset));
            if (idx !== state.currentSubIndex) {
                if(state.currentSubIndex > -1) {
                    const oldRow = document.getElementById(`row-${state.currentSubIndex}`);
                    if(oldRow) oldRow.classList.remove('active');
                }
                if (idx > -1) {
                    els.subText.innerHTML = state.subs[idx].text;
                    els.subLayer.classList.remove('hidden');
                    const newRow = document.getElementById(`row-${idx}`);
                    if(newRow) {
                        newRow.classList.add('active');
                        if(state.sidebarOpen) newRow.scrollIntoView({block: 'center', behavior: 'smooth'});
                    }
                } else {
                    els.subLayer.classList.add('hidden');
                }
                state.currentSubIndex = idx;
            }
        };

        window.adjustOffset = (delta) => {
            state.offset += delta;
            els.offsetDisp.innerText = (state.offset > 0 ? '+' : '') + state.offset + 'ms';
            els.offsetDisp.style.color = state.offset !== 0 ? '#ff8888' : '#ccc';
            updateSubtitles(els.video.currentTime * 1000);
        };

        window.syncSub = (e, index) => {
            e.stopPropagation();
            const sub = state.subs[index];
            const currentVideoTimeMs = els.video.currentTime * 1000;
            state.offset = currentVideoTimeMs - sub.start;
            els.offsetDisp.innerText = (state.offset > 0 ? '+' : '') + state.offset + 'ms';
            els.offsetDisp.style.color = '#ff8888';
            updateSubtitles(currentVideoTimeMs);
        };

        const renderSidebar = () => {
            document.getElementById('sub-count').innerText = state.subs.length;
            els.subList.innerHTML = '';
            const frag = document.createDocumentFragment();
            state.subs.forEach((sub, i) => {
                const div = document.createElement('div');
                div.className = 'sub-item';
                div.id = `row-${i}`;
                div.innerHTML = `
                    <div class="sub-content" onclick="els.video.currentTime = (${sub.start} + state.offset) / 1000">
                        <div class="sub-meta">${msToTimeStr(sub.start)}</div>
                        <div>${sub.text}</div>
                    </div>
                    <button class="sync-btn" title="Sync this line to NOW" onclick="syncSub(event, ${i})">
                        <svg viewBox="0 0 24 24" style="width:16px;height:16px;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-5.5-2.5l7.51-3.22-7.52-1.88 5.26 5.26-5.25-.16z"/></svg>
                    </button>
                `;
                frag.appendChild(div);
            });
            els.subList.appendChild(frag);
        };

        // Events
        els.container.addEventListener('click', (e) => {
            if (e.target.closest('#controls-bar') || e.target.id === 'sub-text') return;
            updatePlayState(els.video.paused);
        });
        document.getElementById('play-btn').onclick = (e) => { e.stopPropagation(); updatePlayState(els.video.paused); };

        els.video.addEventListener('timeupdate', () => {
            const ct = els.video.currentTime;
            const dur = els.video.duration || 0;
            const remain = dur - ct;
            
            els.progressFill.style.width = (dur > 0 ? (ct / dur * 100) : 0) + '%';
            
            // Time Updates
            els.timeLeft.innerText = formatTime(ct);
            els.timeRight.innerText = '-' + formatTime(remain);

            updateSubtitles(ct * 1000);
        });

        els.video.addEventListener('loadedmetadata', () => {
            // Trigger initial render of times
            const ct = els.video.currentTime;
            const dur = els.video.duration || 0;
            els.timeLeft.innerText = formatTime(ct);
            els.timeRight.innerText = '-' + formatTime(dur);
        });

        document.getElementById('progress-bar').addEventListener('click', (e) => {
            e.stopPropagation();
            const rect = e.currentTarget.getBoundingClientRect();
            const pos = (e.clientX - rect.left) / rect.width;
            els.video.currentTime = pos * els.video.duration;
        });

        document.getElementById('sidebar-toggle').addEventListener('click', () => {
            state.sidebarOpen = !state.sidebarOpen;
            if (state.sidebarOpen) els.sidebar.classList.remove('collapsed');
            else els.sidebar.classList.add('collapsed');
        });

        document.getElementById('fullscreen-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            if (!document.fullscreenElement) els.container.requestFullscreen().catch(err => console.log(err));
            else document.exitFullscreen();
        });

        // Drag Drop
        const dropZone = document.body;
        const dragOverlay = document.getElementById('drag-overlay');
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dragOverlay.classList.remove('hidden'); });
        dropZone.addEventListener('dragleave', (e) => { if (e.relatedTarget === null) dragOverlay.classList.add('hidden'); });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dragOverlay.classList.add('hidden');
            [...e.dataTransfer.files].forEach(file => {
                if (file.type.startsWith('video/') || file.name.match(/\.(mkv|webm|mp4|mov)$/i)) loadVideo(file);
                if (file.name.match(/\.(srt|vtt|ass|ssa)$/i)) loadSubs(file);
            });
        });

        // Keyboard
        window.addEventListener('keydown', (e) => {
            if (e.code === 'Space') { e.preventDefault(); updatePlayState(els.video.paused); }
            if (e.code === 'ArrowLeft') els.video.currentTime -= 5;
            if (e.code === 'ArrowRight') els.video.currentTime += 5;
        });

        document.getElementById('video-input').onchange = (e) => loadVideo(e.target.files[0]);
        document.getElementById('sub-input').onchange = (e) => loadSubs(e.target.files[0]);

    </script>
</body>
</html>